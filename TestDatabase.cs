using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Engines;
using ImprovementStoreFlows.DAO;
using ImprovementStoreFlows.Model;

namespace ImprovementStoreFlows
{
    [SimpleJob(RunStrategy.Monitoring, launchCount: 1, warmupCount: 1, targetCount: 50)]
    [MemoryDiagnoser]
    public class TestDatabase
    {
        private const int AMOUNT_FLOWS = 1000;
        private const string FLOW = "{\"flow\":{\"onboarding\":{\"$contentActions\":[{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"33f618eb-ce82-46a9-bc58-7362ed75c676\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":false,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"welcome\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}],\"$id\":\"5af56772-b919-4063-a2ae-ff0d48adbc98\",\"$connId\":\"con_3\",\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"onboarding\",\"root\":true,\"$title\":\"Início\",\"$position\":{\"top\":\"68px\",\"left\":\"231px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"fallback\":{\"$contentActions\":[{\"input\":{\"bypass\":true,\"$cardContent\":{\"document\":{\"id\":\"a953c677-87ba-4da8-af94-cdd10d60fd00\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"error\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}],\"$id\":\"1af84da3-594f-48f1-b897-35e69f4e827d\",\"$connId\":\"con_8\",\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"onboarding\",\"$invalid\":false},\"$tags\":[],\"id\":\"fallback\",\"$title\":\"Exceções\",\"$position\":{\"top\":\"120px\",\"left\":\"877px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"welcome\":{\"$contentActions\":[{\"action\":{\"$id\":\"8aaa01b1-1e49-44f1-80f9-460049367c39\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000000\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000000\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"action\":{\"$id\":\"5e13451c-fbca-4332-a9f9-cf70c3234025\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000001\",\"type\":\"text/plain\",\"content\":\"Olá! {{contact.name}}!\\nSeja bem-vindo(a)!\"},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000001\",\"type\":\"text/plain\",\"content\":\"Olá! {{contact.name}}!\\nSeja bem-vindo(a)!\"},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"07c9c3e1-234f-4816-b3ff-e675a71983f4\",\"type\":\"text/plain\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"typeOfStateId\":\"state\",\"$connId\":\"con_13\",\"$id\":\"7a192fee-b186-4c99-b2a3-21851fec5eaf\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}],\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"welcome\",\"$title\":\"Boas vindas\",\"$position\":{\"top\":\"230px\",\"left\":\"260px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"error\":{\"$contentActions\":[{\"action\":{\"$id\":\"02e0bfc4-18f5-4670-b2a1-2a5c83187ca5\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000002\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000002\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"action\":{\"$id\":\"f80808af-38d6-4c29-8d04-5c30627b51ff\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000003\",\"type\":\"text/plain\",\"content\":\"Desculpe, não consegui entender!\"},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000003\",\"type\":\"text/plain\",\"content\":\"Desculpe, não consegui entender!\"},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"input\":{\"bypass\":true,\"$cardContent\":{\"document\":{\"id\":\"62d7c803-1672-45bd-b081-e83e5a3c41b3\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"onboarding\",\"$invalid\":false},\"$tags\":[],\"id\":\"error\",\"$title\":\"Erro padrão\",\"$position\":{\"top\":\"240px\",\"left\":\"877px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\":{\"$contentActions\":[{\"input\":{\"bypass\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"equals\",\"values\":[\"true\"]}],\"$cardContent\":{\"document\":{\"id\":\"f2c96668-956f-4275-a07d-c9df5fbe95c8\",\"type\":\"text/plain\",\"textContent\":\"Entrada do usuário\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedAttendant\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_18\",\"$id\":\"af0cdb3a-f000-4dae-a06d-c58bab7fe7ec\"},{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClient\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_23\",\"$id\":\"25624d43-6283-4e83-8fc5-d9dc0261039d\"},{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClientInactivity\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_28\",\"$id\":\"5de8987f-23b7-4a3b-8dd9-6a035b5f6aaa\"}],\"$enteringCustomActions\":[{\"$id\":\"0df375b2-d338-40c9-8ac1-0a35f85d3383\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"GetEncodedContactIdentity\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(identity) {\\n return (identity !== undefined) ? encodeURIComponent(identity) : identity;\\n}\",\"inputVariables\":[\"input.message.fromidentity\"],\"outputVariable\":\"helpDeskEncodedFromIdentity\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"4d533c47-a627-4730-b204-988309460e44\",\"$typeOfContent\":\"\",\"type\":\"ProcessCommand\",\"$title\":\"GetOpenTicket\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"from\":\"{{application.identifier}}@{{application.domain}}\",\"to\":\"postmaster@desk.msging.net\",\"method\":\"get\",\"uri\":\"/tickets?$filter=customerIdentity%20eq%20%27{{helpDeskEncodedFromIdentity}}%27%20and%20%28status%20eq%20%27Open%27%20or%20status%20eq%20%27Waiting%27%20or%20status%20eq%20%27Assigned%27%29\",\"metadata\":{\"server.shouldStore\":true},\"variable\":\"helpDeskGetOpenTicketCommandResponse\"}},{\"$id\":\"0f00292f-6854-48be-aacb-c81c95b2e12d\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"TreatGetOpenTicketResponse\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(commandResponse) {\\n    var response = JSON.parse(commandResponse)\\n    var ticketExists = (response && response.resource && response.resource.items && response.resource.items.length > 0);\\n  return ticketExists ? \\\"true\\\" : \\\"false\\\";\\n}\",\"inputVariables\":[\"helpDeskGetOpenTicketCommandResponse\"],\"outputVariable\":\"helpDeskHasTicket\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"669a2829-2d70-4797-83ee-d57b6c7d3ed3\",\"$typeOfContent\":\"\",\"type\":\"ProcessCommand\",\"$title\":\"OpenTicketIfNotFound\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"notEquals\",\"values\":[\"true\"]}],\"settings\":{\"from\":\"{{application.identifier}}@{{application.domain}}\",\"to\":\"postmaster@desk.msging.net\",\"method\":\"set\",\"uri\":\"/tickets/{{helpDeskEncodedFromIdentity}}\",\"variable\":\"helpDeskOpenTicketCommandResponse\",\"type\":\"text/plain\",\"resource\":\"{{input.content}}\",\"metadata\":{\"server.shouldStore\":true}}},{\"$id\":\"46ea9f62-b52e-46bd-8279-100655a1acae\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"TreatOpenTicketResponse\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"notEquals\",\"values\":[\"true\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(commandResponse) {\\n    var response = commandResponse ? JSON.parse(commandResponse) : {}\\n    var ticketExists = response && response.type === \\\"application/vnd.iris.ticket+json\\\" && response.resource \\n    return ticketExists ? \\\"true\\\" : \\\"false\\\";\\n}\",\"inputVariables\":[\"helpDeskOpenTicketCommandResponse\"],\"outputVariable\":\"helpDeskHasTicket\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"cb6917b3-18a2-4977-9d02-96a2552c8640\",\"$typeOfContent\":\"\",\"type\":\"ForwardMessageToDesk\",\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"equals\",\"values\":[\"true\"]}],\"settings\":{},\"$invalid\":false}],\"$leavingCustomActions\":[{\"$id\":\"93c9a7a5-1aaa-4d36-97eb-4c72c5131852\",\"$typeOfContent\":\"\",\"type\":\"SetVariable\",\"$title\":\"ResetHasTicket\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedAttendant\",\"ClosedClient\",\"ClosedClientInactivity\"]}],\"settings\":{\"variable\":\"helpDeskHasTicket\",\"value\":\"false\",\"$invalid\":false}}],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"$invalid\":false},\"$tags\":[],\"id\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"deskStateVersion\":\"2.00\",\"root\":false,\"$title\":\"Atendimento humano\",\"$position\":{\"top\":\"412px\",\"left\":\"406px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\":{\"$contentActions\":[{\"action\":{\"$id\":\"e6d14071-9a9b-4cd4-9e7c-0244dd1eb1d7\",\"$typeOfContent\":\"chat-state\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"d28e28d2-b537-4f7d-8007-9675dea6bc9e\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"d28e28d2-b537-4f7d-8007-9675dea6bc9e\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\"}},\"$invalid\":false},{\"action\":{\"$id\":\"6a132ee8-56e0-48cd-a3d6-bec72269bbbc\",\"$typeOfContent\":\"text\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"7837d488-f090-4ad6-bb10-14ca49d42033\",\"type\":\"text/plain\",\"content\":\"saiu\",\"metadata\":{}},\"$cardContent\":{\"document\":{\"id\":\"7837d488-f090-4ad6-bb10-14ca49d42033\",\"type\":\"text/plain\",\"content\":\"saiu\"},\"editable\":true,\"deletable\":true,\"position\":\"left\"}},\"$invalid\":false},{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"6ceb02bd-b574-4bb0-9979-8ec4a5903da0\",\"type\":\"text/plain\",\"textContent\":\"Entrada do usuário\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"welcome\",\"typeOfStateId\":\"state\",\"$connId\":\"con_33\",\"$id\":\"38206322-0aab-4028-91f7-f1d49d327436\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}],\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"root\":false,\"$title\":\"saiu\",\"$position\":{\"top\":\"204px\",\"left\":\"607px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false}},\"globalActions\":{\"$contentActions\":[],\"$conditionOutputs\":[],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"global-actions\",\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false}}";
        private const string FLOW_CHANGED = "{\"flow\":{\"onboarding2\":{\"$contentActions\":[{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"33f618eb-ce82-46a9-bc58-7362ed75c676\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":false,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"welcome\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}],\"$id\":\"5af56772-b919-4063-a2ae-ff0d48adbc98\",\"$connId\":\"con_3\",\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"onboarding\",\"root\":true,\"$title\":\"Início\",\"$position\":{\"top\":\"68px\",\"left\":\"231px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"fallback\":{\"$contentActions\":[{\"input\":{\"bypass\":true,\"$cardContent\":{\"document\":{\"id\":\"a953c677-87ba-4da8-af94-cdd10d60fd00\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"error\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}],\"$id\":\"1af84da3-594f-48f1-b897-35e69f4e827d\",\"$connId\":\"con_8\",\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"onboarding\",\"$invalid\":false},\"$tags\":[],\"id\":\"fallback\",\"$title\":\"Exceções\",\"$position\":{\"top\":\"120px\",\"left\":\"877px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"welcome\":{\"$contentActions\":[{\"action\":{\"$id\":\"8aaa01b1-1e49-44f1-80f9-460049367c39\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000000\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000000\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"action\":{\"$id\":\"5e13451c-fbca-4332-a9f9-cf70c3234025\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000001\",\"type\":\"text/plain\",\"content\":\"Olá! {{contact.name}}!\\nSeja bem-vindo(a)!\"},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000001\",\"type\":\"text/plain\",\"content\":\"Olá! {{contact.name}}!\\nSeja bem-vindo(a)!\"},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"07c9c3e1-234f-4816-b3ff-e675a71983f4\",\"type\":\"text/plain\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"typeOfStateId\":\"state\",\"$connId\":\"con_13\",\"$id\":\"7a192fee-b186-4c99-b2a3-21851fec5eaf\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}],\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"welcome\",\"$title\":\"Boas vindas\",\"$position\":{\"top\":\"230px\",\"left\":\"260px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"error\":{\"$contentActions\":[{\"action\":{\"$id\":\"02e0bfc4-18f5-4670-b2a1-2a5c83187ca5\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000002\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000002\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"action\":{\"$id\":\"f80808af-38d6-4c29-8d04-5c30627b51ff\",\"$typeOfContent\":\"\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"00000000-0000-0000-0000-000000000003\",\"type\":\"text/plain\",\"content\":\"Desculpe, não consegui entender!\"},\"$cardContent\":{\"document\":{\"id\":\"00000000-0000-0000-0000-000000000003\",\"type\":\"text/plain\",\"content\":\"Desculpe, não consegui entender!\"},\"editable\":true,\"deletable\":true,\"position\":\"left\",\"editing\":false}},\"$invalid\":false},{\"input\":{\"bypass\":true,\"$cardContent\":{\"document\":{\"id\":\"62d7c803-1672-45bd-b081-e83e5a3c41b3\",\"type\":\"text/plain\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"onboarding\",\"$invalid\":false},\"$tags\":[],\"id\":\"error\",\"$title\":\"Erro padrão\",\"$position\":{\"top\":\"240px\",\"left\":\"877px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\":{\"$contentActions\":[{\"input\":{\"bypass\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"equals\",\"values\":[\"true\"]}],\"$cardContent\":{\"document\":{\"id\":\"f2c96668-956f-4275-a07d-c9df5fbe95c8\",\"type\":\"text/plain\",\"textContent\":\"Entrada do usuário\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedAttendant\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_18\",\"$id\":\"af0cdb3a-f000-4dae-a06d-c58bab7fe7ec\"},{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClient\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_23\",\"$id\":\"25624d43-6283-4e83-8fc5-d9dc0261039d\"},{\"$isDeskOutput\":true,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClientInactivity\"]}],\"$invalid\":false,\"stateId\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"$connId\":\"con_28\",\"$id\":\"5de8987f-23b7-4a3b-8dd9-6a035b5f6aaa\"}],\"$enteringCustomActions\":[{\"$id\":\"0df375b2-d338-40c9-8ac1-0a35f85d3383\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"GetEncodedContactIdentity\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(identity) {\\n return (identity !== undefined) ? encodeURIComponent(identity) : identity;\\n}\",\"inputVariables\":[\"input.message.fromidentity\"],\"outputVariable\":\"helpDeskEncodedFromIdentity\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"4d533c47-a627-4730-b204-988309460e44\",\"$typeOfContent\":\"\",\"type\":\"ProcessCommand\",\"$title\":\"GetOpenTicket\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"from\":\"{{application.identifier}}@{{application.domain}}\",\"to\":\"postmaster@desk.msging.net\",\"method\":\"get\",\"uri\":\"/tickets?$filter=customerIdentity%20eq%20%27{{helpDeskEncodedFromIdentity}}%27%20and%20%28status%20eq%20%27Open%27%20or%20status%20eq%20%27Waiting%27%20or%20status%20eq%20%27Assigned%27%29\",\"metadata\":{\"server.shouldStore\":true},\"variable\":\"helpDeskGetOpenTicketCommandResponse\"}},{\"$id\":\"0f00292f-6854-48be-aacb-c81c95b2e12d\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"TreatGetOpenTicketResponse\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"state.previous.id\",\"comparison\":\"notEquals\",\"values\":[\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(commandResponse) {\\n    var response = JSON.parse(commandResponse)\\n    var ticketExists = (response && response.resource && response.resource.items && response.resource.items.length > 0);\\n  return ticketExists ? \\\"true\\\" : \\\"false\\\";\\n}\",\"inputVariables\":[\"helpDeskGetOpenTicketCommandResponse\"],\"outputVariable\":\"helpDeskHasTicket\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"669a2829-2d70-4797-83ee-d57b6c7d3ed3\",\"$typeOfContent\":\"\",\"type\":\"ProcessCommand\",\"$title\":\"OpenTicketIfNotFound\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"notEquals\",\"values\":[\"true\"]}],\"settings\":{\"from\":\"{{application.identifier}}@{{application.domain}}\",\"to\":\"postmaster@desk.msging.net\",\"method\":\"set\",\"uri\":\"/tickets/{{helpDeskEncodedFromIdentity}}\",\"variable\":\"helpDeskOpenTicketCommandResponse\",\"type\":\"text/plain\",\"resource\":\"{{input.content}}\",\"metadata\":{\"server.shouldStore\":true}}},{\"$id\":\"46ea9f62-b52e-46bd-8279-100655a1acae\",\"$typeOfContent\":\"\",\"type\":\"ExecuteScript\",\"$title\":\"TreatOpenTicketResponse\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"notEquals\",\"values\":[\"true\"]}],\"settings\":{\"function\":\"run\",\"source\":\"function run(commandResponse) {\\n    var response = commandResponse ? JSON.parse(commandResponse) : {}\\n    var ticketExists = response && response.type === \\\"application/vnd.iris.ticket+json\\\" && response.resource \\n    return ticketExists ? \\\"true\\\" : \\\"false\\\";\\n}\",\"inputVariables\":[\"helpDeskOpenTicketCommandResponse\"],\"outputVariable\":\"helpDeskHasTicket\",\"LocalTimeZoneEnabled\":false}},{\"$id\":\"cb6917b3-18a2-4977-9d02-96a2552c8640\",\"$typeOfContent\":\"\",\"type\":\"ForwardMessageToDesk\",\"conditions\":[{\"source\":\"context\",\"variable\":\"helpDeskHasTicket\",\"comparison\":\"equals\",\"values\":[\"true\"]}],\"settings\":{},\"$invalid\":false}],\"$leavingCustomActions\":[{\"$id\":\"93c9a7a5-1aaa-4d36-97eb-4c72c5131852\",\"$typeOfContent\":\"\",\"type\":\"SetVariable\",\"$title\":\"ResetHasTicket\",\"$invalid\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedAttendant\",\"ClosedClient\",\"ClosedClientInactivity\"]}],\"settings\":{\"variable\":\"helpDeskHasTicket\",\"value\":\"false\",\"$invalid\":false}}],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"$invalid\":false},\"$tags\":[],\"id\":\"desk:6ace3a41-32b4-4923-a89b-98b9a37dcc3f\",\"deskStateVersion\":\"2.00\",\"root\":false,\"$title\":\"Atendimento humano\",\"$position\":{\"top\":\"412px\",\"left\":\"406px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false},\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\":{\"$contentActions\":[{\"action\":{\"$id\":\"e6d14071-9a9b-4cd4-9e7c-0244dd1eb1d7\",\"$typeOfContent\":\"chat-state\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"d28e28d2-b537-4f7d-8007-9675dea6bc9e\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"$cardContent\":{\"document\":{\"id\":\"d28e28d2-b537-4f7d-8007-9675dea6bc9e\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000}},\"editable\":true,\"deletable\":true,\"position\":\"left\"}},\"$invalid\":false},{\"action\":{\"$id\":\"6a132ee8-56e0-48cd-a3d6-bec72269bbbc\",\"$typeOfContent\":\"text\",\"type\":\"SendMessage\",\"settings\":{\"id\":\"7837d488-f090-4ad6-bb10-14ca49d42033\",\"type\":\"text/plain\",\"content\":\"saiu\",\"metadata\":{}},\"$cardContent\":{\"document\":{\"id\":\"7837d488-f090-4ad6-bb10-14ca49d42033\",\"type\":\"text/plain\",\"content\":\"saiu\"},\"editable\":true,\"deletable\":true,\"position\":\"left\"}},\"$invalid\":false},{\"input\":{\"bypass\":false,\"$cardContent\":{\"document\":{\"id\":\"6ceb02bd-b574-4bb0-9979-8ec4a5903da0\",\"type\":\"text/plain\",\"textContent\":\"Entrada do usuário\",\"content\":\"Entrada do usuário\"},\"editable\":false,\"deletable\":true,\"position\":\"right\",\"editing\":false},\"$invalid\":false},\"$invalid\":false}],\"$conditionOutputs\":[{\"stateId\":\"welcome\",\"typeOfStateId\":\"state\",\"$connId\":\"con_33\",\"$id\":\"38206322-0aab-4028-91f7-f1d49d327436\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}],\"$invalid\":false}],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"64bac3a7-8a7a-4ad1-86a4-a304245acbc2\",\"root\":false,\"$title\":\"saiu\",\"$position\":{\"top\":\"204px\",\"left\":\"607px\"},\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false,\"$invalid\":false}},\"globalActions\":{\"$contentActions\":[],\"$conditionOutputs\":[],\"$enteringCustomActions\":[],\"$leavingCustomActions\":[],\"$inputSuggestions\":[],\"$defaultOutput\":{\"stateId\":\"fallback\",\"$invalid\":false},\"$tags\":[],\"id\":\"global-actions\",\"$invalidContentActions\":false,\"$invalidOutputs\":false,\"$invalidCustomActions\":false}}";
       
        private const string MONGODB_TYPE = "MongoDb";
        private const string SQLSERVER_TYPE = "SQLServer";
        private const string SQLSERVER_CLUSTERED_COLUMNSTORE_TYPE = "SQLServerColumnStore";

        private Dictionary<string, IDAO> daoList = new Dictionary<string, IDAO>();
        private List<FlowIdentity> _currentFlows;

        //private int interation = 0;

        [Params(MONGODB_TYPE, SQLSERVER_TYPE, SQLSERVER_CLUSTERED_COLUMNSTORE_TYPE)]
        public string ExecutionType { get; set; } = "";

        public TestDatabase()
        {
            FillDaoList();
            _currentFlows = new List<FlowIdentity>();
        }

        /*
        [IterationSetup]
        public void IterationSetup()
        {
            interation++;
        }
        */

        [Benchmark]
        public async Task InsertRegisters()
        {
            var dao = GetDAO(ExecutionType);

            _currentFlows.Clear();

            for (int i = 1; i <= AMOUNT_FLOWS; i++)
            {
                var _currentFlow = new FlowIdentity()
                {
                    Id = Guid.NewGuid(),
                    Flow = FLOW
                };

                _currentFlows.Add(_currentFlow);
                await dao.InsertAsync(_currentFlow);
            }
        }

        [Benchmark]
        public async Task UpdateRegisters()
        {
            var dao = GetDAO(ExecutionType);

            var flows = GetCurrentFlows();
            foreach (var flow in flows)
            {
                flow.Flow = FLOW_CHANGED;
                await dao.UpdateAsync(flow);
            }
        }

        [Benchmark]
        public async Task GetRegister()
        {
            var dao = GetDAO(ExecutionType);

            var flows = GetCurrentFlows();
            foreach (var flow in flows)
            {
                await dao.GetAsync(flow.Id);
            }
        }

        /*
        [Benchmark]
        public async Task DeleteRegisters()
        {
            var dao = GetDAO(ExecutionType);

            await dao.DeleteAsync(GetCurrentFlow().Id);
        }
        */

        private void FillDaoList()
        {
            daoList.Add(MONGODB_TYPE, new MongoDbDAO());
            daoList.Add(SQLSERVER_TYPE, new SqlServerDAO("Flows"));
            daoList.Add(SQLSERVER_CLUSTERED_COLUMNSTORE_TYPE, new SqlServerDAO("FlowsClusteredColumnStore"));
        }

        private IDAO GetDAO(string executionType)
        {
            daoList.TryGetValue(executionType, out var dao);
            if (dao == null)
            {
                throw new InvalidOperationException();
            }
            return dao;
        }

        private List<FlowIdentity> GetCurrentFlows() => _currentFlows;

    }
}
